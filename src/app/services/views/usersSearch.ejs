<div class="govuk-width-container govuk-main-wrapper">
    <div class="govuk-grid-row">
        <div class="govuk-grid-column-three-quarters">
        <% if (locals.flash.info) { %>
            <div id="notification-wrapper" class="govuk-notification-banner govuk-notification-banner--success" role="alert" aria-labelledby="govuk-notification-banner-title" data-module="govuk-notification-banner">
                <div class="govuk-notification-banner__header">
                    <span class="close-button">x</span>
                    <h2 class="govuk-notification-banner__title" id="govuk-notification-banner-title">
                        Success
                    </h2>
                </div>
                <div class="govuk-notification-banner__content">
                    <p class="govuk-body">
                        <%=locals.flash.info%>
                    </p>
                </div>
            </div>
        <% } %>
            <h1 class="govuk-heading-xl govuk-!-margin-top-0 text-break">
                <span class="govuk-caption-xl"><%=locals.service.name%></span>
                Users
            </h1>
        </div>
    </div>

    <%
    const paginationModel = {
        method: 'post',
        csrfToken,
        currentPage: locals.page,
        numberOfPages: locals.numberOfPages,
        totalNumberOfResults: locals.totalNumberOfResults,
        numberOfResultsOnPage: locals.users.length,
        data: [
            { key: 'criteria', value: locals.criteria },
            { key: 'sort', value: locals.sortBy },
            { key: 'sortDir', value: locals.sortOrder },
            { key: 'showFilters', value: locals.showFilters }
        ]
    }
    %>

    <div class="govuk-grid-row">
        <div class="govuk-grid-column-three-quarters">
            <form method="post" id="form-user-search">
                <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
                <fieldset class="govuk-fieldset">
                    <div class="govuk-form-group">
                        <label for="criteria" class="govuk-label govuk-label--s govuk-visually-hidden">
                            Search by name, email or organisation
                        </label>
                        <input
                            class="govuk-input govuk-!-width-three-quarters"
                            type="text"
                            id="criteria"
                            name="criteria"
                            value="<%= criteria %>"
                            placeholder="Search by name, email or organisation" />
                        <button type="submit" class="govuk-button" data-module="govuk-button">
                            Search
                        </button>
                    </div>
                </fieldset>
            </form>
        </div>
        <% if (locals.allowInvite) { %>

        <div class="govuk-grid-column-one-quarter">
            <a href="users/new-user" class="govuk-button govuk-button--secondary pull-right">Invite user</a>
        </div>

        <% } %>
    </div>

    <div class="govuk-grid-row">
        <div class="govuk-grid-column-full">
            <%- include('../../layouts/pagination', paginationModel); %>
            <table class="govuk-table data">
                <thead class="govuk-table__head">
                    <% let baseSortUri = `?criteria=${criteria}&page=${page}`; %>
                    <tr class="govuk-table__row sortable">
                        <th scope="col" class="govuk-table__header width-20">
                            <a
                                href="<%=baseSortUri%>&sort=name&sortdir=<%= sort.name.nextDirection %>"
                                class="govuk-link-bold govuk-link--no-underline <% if (sort.name.applied) { %>sorted dir-<%= (sort.name.nextDirection === 'desc') ? 'd' : 'a' %> <% } %>">
                                Name
                            </a>
                        </th>
                        <th scope="col" class="govuk-table__header width-30">
                            <a
                                href="<%=baseSortUri%>&sort=email&sortdir=<%= sort.email.nextDirection %>"
                                class="govuk-link-bold govuk-link--no-underline <% if (sort.email.applied) { %>sorted dir-<%= (sort.email.nextDirection === 'desc') ? 'd' : 'a' %> <% } %>">
                                Email
                            </a>
                        </th>
                        <th scope="col" class="govuk-table__header width-25">
                            <a
                                href="<%=baseSortUri%>&sort=organisation&sortdir=<%= sort.organisation.nextDirection %>"
                                class="govuk-link-bold govuk-link--no-underline <% if (sort.organisation.applied) { %>sorted dir-<%= (sort.organisation.nextDirection === 'desc') ? 'd' : 'a' %> <% } %>">
                                Organisation
                            </a>
                        </th>
                        <th scope="col" class="govuk-table__header width-15">
                            <a
                                href="<%=baseSortUri%>&sort=lastlogin&sortdir=<%= sort.lastLogin.nextDirection %>"
                                class="govuk-link-bold govuk-link--no-underline <% if (sort.lastLogin.applied) { %>sorted dir-<%= (sort.lastLogin.nextDirection === 'desc') ? 'd' : 'a' %> <% } %>">
                                Last Login
                            </a>
                        </th>
                        <th scope="col" class="govuk-table__header width-10 govuk-table__header--numeric">
                            <a
                                href="<%=baseSortUri%>&sort=status&sortdir=<%= sort.status.nextDirection %>"
                                class="govuk-link-bold govuk-link--no-underline <% if (sort.status.applied) { %>sorted dir-<%= (sort.status.nextDirection === 'desc') ? 'd' : 'a' %> <% } %>">
                                Status
                            </a>
                        </th>
                    </tr>
                </thead>
                <tbody class="govuk-table__body">
                    <% if(locals.users.length === 0 && locals.criteria) { %>
                    <td class="govuk-table__cell" colspan="5">
                        <div class="empty-state">
                            <p class="govuk-body">No users found</p>
                        </div>
                    </td>
                    <% } %> <% for (let i = 0; i < locals.users.length; i++) { %>
                    <tr class="govuk-table__row">
                        <th scope="row" class="govuk-table__header govuk-!-padding-bottom-4 govuk-!-padding-top-4">
                                <a
                                    class="govuk-link"
                                    href="/services/<%= locals.serviceId %>/users/<%= users[i].id %>/organisations">
                                    <%= users[i].name %>
                                </a>
                        </th>

                        <td class="govuk-table__cell govuk-!-font-size-16">
                            <span class="breakable"><%= users[i].email %></span>
                        </td>
                        <td class="govuk-table__cell govuk-!-font-size-16">
                            <% if(users[i].organisation) { %> <%= users[i].organisation.name %> <% }else { %> Unknown <%
                            } %>
                        </td>
                        <td class="govuk-table__cell govuk-!-font-size-16">
                            <% if(locals.users[i].lastLogin) { %> <%= locals.moment(locals.users[i].lastLogin).fromNow()
                            %> <% } else { %> Never <% } %>
                        </td>
                        <td class="govuk-table__cell govuk-!-font-size-16 govuk-table__cell--numeric">
                            <%= users[i].status.description %>
                        </td>
                    </tr>
                    <% } %>
                </tbody>
            </table>
            <%- include('../../layouts/pagination', paginationModel); %>
        </div>
    </div>
</div>
