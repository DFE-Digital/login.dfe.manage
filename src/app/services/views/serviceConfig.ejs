<div class="govuk-width-container govuk-main-wrapper">
    <div class="govuk-grid-row">
        <div class="govuk-grid-column-two-thirds">
        <% if (locals.flash.info) { %>
            <div id="notification-wrapper" class="govuk-notification-banner govuk-notification-banner--success" role="alert" aria-labelledby="govuk-notification-banner-title" data-module="govuk-notification-banner">
                <div class="govuk-notification-banner__header">
                    <span class="close-button">x</span>
                    <h2 class="govuk-notification-banner__title" id="govuk-notification-banner-title">
                        Success
                    </h2>
                </div>
                <div class="govuk-notification-banner__content">
                    <p class="govuk-body">
                        <%=locals.flash.info%>
                    </p>
                </div>
            </div>
        <% } %>
            <h1 class="govuk-heading-xl govuk-!-margin-top-0 text-break">
                <span class="govuk-caption-xl"><%=locals.service.name%></span>
                Edit service configuration
            </h1>
            <p class="govuk-body-l">View and edit your service configuration.</p>
        </div>
        <!-- TODO: add help link -->
        <div class="govuk-grid-column-one-third">
            <aside id="related-actions" class="govuk-!-margin-top-0">
                <h2 class="govuk-heading-m">Related actions</h2>
                <ul class="govuk-list">
                    <li>
                        <a class="govuk-link-bold" href="">Help with service configuration</a>
                    </li>
                </ul>
            </aside>
        </div>
    </div>

    <div class="govuk-grid-row">
        <div class="govuk-grid-column-full">
            <form method="post" class="prevent-form-double-submission" id="form-service-config">
                <input type="hidden" name="_csrf" value="<%=csrfToken%>" />
                <fieldset  class="govuk-fieldset govuk-!-margin-top-3">
                    <legend class="govuk-fieldset__legend govuk-fieldset__legend--l">
                        Service details
                    </legend>
                    <!-- TODO: update the address to help page -->
                    <p class="govuk-body">Read the <a href="">service configuration help page</a> to find out more about service details:</p>
                    <ul class="govuk-list govuk-list--bullet">
                        <li>home URL</li>
                        <li>post password-reset URL</li>
                      </ul>


                    <div class="govuk-form-group<%= (locals.validationMessages.serviceHome !== undefined) ? ' govuk-form-group--error' : ''%>">
                        <h1 class="govuk-label-wrapper">
                            <label class="govuk-label govuk-label--m" for="serviceHome">
                                Home URL
                            </label>
                        </h1>
                        <div id="home-url-hint" class="govuk-hint">
                            The home page of the service you want to configure. It is usually the service landing page from DfE Sign-in.
                        </div>

                        <% if (locals.validationMessages.serviceHome !== undefined){ %>
                        <p id="validation-homeUrl" class="govuk-error-message">
                        <span class="govuk-visually-hidden">Error:</span>
                        <%=locals.validationMessages.serviceHome %>
                        </p>
                        <% } %>

                        <input class="form-control  govuk-input" id="serviceHome" name="serviceHome" type="text"
                            value="<%=locals.service.serviceHome%>">
                    </div>

                    <div class="govuk-form-group<%= (locals.validationMessages.postResetUrl !== undefined) ? ' govuk-form-group--error' : ''%>">
                        <h1 class="govuk-label-wrapper">
                            <label class="govuk-label govuk-label--m" for="postResetUrl">
                                Post password-reset URL
                            </label>
                        </h1>
                        <div id="post-reset-url-hint" class="govuk-hint">
                            Where you want to redirect users after they have reset their password. It is usually the DfE Sign-in home page.
                        </div>

                        <% if (locals.validationMessages.postResetUrl !== undefined){ %>
                        <p id="validation-postResetUrl" class="govuk-error-message">
                          <span class="govuk-visually-hidden">Error:</span>
                          <%=locals.validationMessages.postResetUrl %>
                        </p>
                        <% } %>

                        <input class="form-control govuk-input" id="postResetUrl" name="postResetUrl" type="text"
                            value="<%=locals.service.postResetUrl%>" />
                    </div>
                </fieldset>

                <hr class="govuk-section-break govuk-section-break--visible">

                <fieldset  class="govuk-fieldset govuk-!-margin-top-3">
                    <legend class="govuk-fieldset__legend govuk-fieldset__legend--l">
                        OpenID Connect
                    </legend>
                    <!-- TODO: update the address to help page -->
                    <p class="govuk-body">Read the <a href="">service configuration help page</a> to find out more about OpenID Connect:</p>
                    <ul class="govuk-list govuk-list--bullet">
                        <li>client ID</li>
                        <li>redirect URL</li>
                        <li>logout redirect URL</li>
                        <li>response types</li>
                        <li>refresh_token</li>
                        <li>client secret</li>
                        <li>token endpoint authentication method</li>
                    </ul>

                    <div class="govuk-form-group">
                        <h1 class="govuk-label-wrapper">
                            <label class="govuk-label govuk-label--m" for="clientId">
                                Client ID
                            </label>
                        </h1>
                        <div id="client-id-hint" class="govuk-hint">
                            A unique identifier of the service that is created manually by the DfE Sign-in team. You cannot change this value.
                        </div>

                        <input class="form-control govuk-input read-only-input govuk-!-width-one-half" id="clientId"
                            name="clientId"
                            type="text" 
                            readonly="readonly"
                            value="<%=locals.service.clientId%>"/>
                    </div>

                    <% function generateRedirectUrlsSection(sectionId, heading, hint, urlsData, validationMessages) { %>
                        <div id="<%= sectionId %>-form-group" data-<%= sectionId %>-counter="<%= (urlsData.length > 0) ? (urlsData.length + 1) : 2 %>" class="govuk-form-group <%= (validationMessages !== undefined) ? 'govuk-form-group--error' : '' %>">
                            <h1 class="govuk-heading-m govuk-!-margin-bottom-2" id="<%= sectionId %>-heading"> <%= heading %> </h1>
                            <div id="<%= sectionId %>-hint" class="govuk-hint">
                                <%= hint %>
                            </div>
                    
                            <% if (urlsData.length > 0) { %>
                                <% if (validationMessages !== undefined) { %>
                                <p id="<%= sectionId %>-validation" class="govuk-error-message">
                                    <span class="govuk-visually-hidden">Error:</span>
                                    <%= validationMessages %>
                                </p>
                                <% } %>
                                <% for (let i = 0; i < urlsData.length; i++) { 
                                    const url = urlsData[i];
                                %>
                                    <p class="govuk-body input-config-container" id="<%= sectionId %>-input-group-<%= i+1 %>">
                                        <label for="<%= sectionId %>-input-<%= i+1 %>" class="govuk-label govuk-label--s govuk-visually-hidden">
                                           <%= heading %>
                                        </label>
                                        <input
                                            class="form-control input-config govuk-input"
                                            id="<%= sectionId %>-input-<%= i+1 %>"
                                            name="<%= sectionId %>"
                                            value="<%= url %>" />
                                        <a href="#" class="govuk-link govuk-link--no-visited-state remove-redirect" id="<%= sectionId %>-remove-<%= i+1 %>" data-group-id="<%= i+1 %>">Remove</a>
                                    </p>
                                <% } %>
                            <% } else { %>
                                <% if (validationMessages !== undefined) { %>
                                <p id="<%= sectionId %>-validation" class="govuk-error-message">
                                    <span class="govuk-visually-hidden">Error:</span>
                                    <%= validationMessages %>
                                </p>
                                <% } %>
                                <p class="govuk-body input-config-container" id="<%= sectionId %>-input-group-1">
                                    <label for="<%= sectionId %>-1" class="govuk-label govuk-label--s govuk-visually-hidden">
                                       <%= heading %>
                                    </label>
                                    <input
                                        class="form-control input-config govuk-input"
                                        id="<%= sectionId %>-1"
                                        name="<%= sectionId %>"
                                    />
                                    <a href="#" class="govuk-link govuk-link--no-visited-state remove-redirect" id="<%= sectionId %>-remove-1" data-group-id="1">Remove</a>
                                </p>
                            <% } %>
                        </div>
                        <a href="" class="govuk-button" id="<%= sectionId %>-add">Add Url</a>
                    <% } %>

                    <%

                    const sectionsData = [
                        {
                            sectionId: 'redirect_uris', 
                            heading: 'Redirect URL', 
                            hint: 'Where you want to redirect users after they have authenticated. Add at least 1 URL.', 
                            urlsData: locals.service.redirectUris, 
                            validationMessages: locals.validationMessages.redirect_uris 
                        },
                        {
                            sectionId: 'post_logout_redirect_uris', 
                            heading: 'Logout redirect URL', 
                            hint: 'Where you want to redirect users after they log out of a service. Add at least 1 URL.', 
                            urlsData: locals.service.postLogoutRedirectUris, 
                            validationMessages: locals.validationMessages.post_logout_redirect_uris 
                        }
                    ];

                        for (const section of sectionsData) {
                            generateRedirectUrlsSection(
                                section.sectionId,
                                section.heading,
                                section.hint,
                                section.urlsData,
                                section.validationMessages
                            );
                        }
                    %>
                    
                </fieldset>

                     <!-- Client secredt OLD section  -->
                        <div class="govuk-summary-list__row">
                            <dt class="govuk-summary-list__key">
                                <label for="clientSecret" class="govuk-label govuk-label--s">
                                    Client secret
                                </label>
                            </dt>
                            <dd class="govuk-summary-list__value">
                                <div
                                    class="govuk-form-group <%= (locals.validationMessages.clientSecret !== undefined) ? 'govuk-form-group--error' : ''%>">
                                    <a href="" class="govuk-link pull-right" id="generate-client-secret">Regenerate</a>
                                    <% if (locals.validationMessages.clientSecret !== undefined){ %>
                                    <p id="validation-clientSecret" class="govuk-error-message">
                                        <span class="govuk-visually-hidden">Error:</span>
                                        <%=locals.validationMessages.clientSecret %>
                                    </p>
                                    <% } %>

                                    <div class="show-password full-width" id="secret-input">
                                        <input
                                            class="password-input form-control read-only-input govuk-input"
                                            id="clientSecret"
                                            name="clientSecret"
                                            type="password"
                                            value="<%=locals.service.clientSecret%>"
                                            readonly="readonly" />
                                    </div>
                                </div>
                            </dd>
                        </div>



                        <!-- Redirect URLS -->
<!--                         <div class="govuk-summary-list__row">
                            <dt class="govuk-summary-list__key">
                                <span class="govuk-label govuk-label--s">Redirect Urls</span>
                            </dt>
                            <dd class="govuk-summary-list__value">
                                <div
                                    id="redirect-url"
                                    class="govuk-form-group <%= (locals.validationMessages.redirect_uris !== undefined) ? 'govuk-form-group--error' : '' %>">
                                    <fieldset class="govuk-fieldset">
                                        <legend class="govuk-fieldset__legend govuk-visually-hidden">Redirect Urls</legend>
                                        <a href="" class="govuk-link pull-right" id="add-redirect">Add Url</a>
                                    <% if (locals.service.redirectUris.length > 0) { %>
                                        <% if (locals.validationMessages.redirect_uris !== undefined) { %>
                                        <p id="validation-redirect_uris" class="govuk-error-message">
                                            <span class="govuk-visually-hidden">Error:</span>
                                            <%=locals.validationMessages.redirect_uris %>
                                        </p>
                                        <% } %>
                                        <% for (let i=0; i < locals.service.redirectUris.length; i++) { 
                                            const redirect_uri = locals.service.redirectUris[i];
                                        %>
                                            <label for="redirect_uris<%= i > 0 ? `-${i}`  : '' %>" class="govuk-label govuk-label--s govuk-visually-hidden">
                                                Redirect Url
                                            </label>
                                            <p class="govuk-body">
                                                <input
                                                    class="form-control inputConfig govuk-input"
                                                    id="redirect_uris<%= i > 0 ? `-${i}`  : '' %>"
                                                    name="redirect_uris"
                                                    value="<%=redirect_uri%>" />
                                            </p>
                                        <% } %>
                                    <% } else { %>
                                        <label for="redirect" class="govuk-label govuk-label--s govuk-visually-hidden">
                                            Redirect Url
                                        </label>
                                        <% if (locals.validationMessages.redirect_uris !== undefined) { %>
                                        <p id="validation-homeUrl" class="govuk-error-message">
                                            <span class="govuk-visually-hidden">Error:</span>
                                            <%=locals.validationMessages.redirect_uris%>
                                        </p>
                                        <% } %>
                                        <p class="govuk-body">
                                            <input
                                                class="form-control inputConfig govuk-input"
                                                id="redirect_uris"
                                                name="redirect_uris" />
                                        </p>
                                    <% } %>
                                    </fieldset>
                                </div>
                            </dd>
                        </div> -->

                        <!-- Logout redirect URLS Old section -->
                        <div class="govuk-summary-list__row">
                            <dt class="govuk-summary-list__key">
                                <span class="govuk-label govuk-label--s">Logout redirect Urls</span>
                            </dt>
                            <dd class="govuk-summary-list__value">
                                <div
                                    id="logout-url"
                                    class="govuk-form-group <%= (locals.validationMessages.post_logout_redirect_uris !== undefined) ? 'govuk-form-group--error' : ''%>">
                                    <fieldset class="govuk-fieldset">
                                        <legend class="govuk-fieldset__legend govuk-visually-hidden">Logout redirect Urls</legend>
                                    <a href="" class="govuk-link pull-right" id="add-logout">Add Url</a>
                                    <% if (locals.service.postLogoutRedirectUris.length > 0) { %>
                                        <% if (locals.validationMessages.post_logout_redirect_uris !== undefined){ %>
                                        <p id="validation-homeUrl" class="govuk-error-message">
                                            <span class="govuk-visually-hidden">Error:</span>
                                            <%=locals.validationMessages.post_logout_redirect_uris%>
                                        </p>
                                        <% } %>
                                        <% for (let i=0; i < locals.service.postLogoutRedirectUris.length; i++) {
                                            const logout_redirect = locals.service.postLogoutRedirectUris[i];
                                        %>
                                            <label for="post_logout_redirect_uris<%= i > 0 ? `-${i}`  : '' %>" class="govuk-label govuk-label--s govuk-visually-hidden">
                                                Logout redirect Url
                                            </label>
                                            <p class="govuk-body">
                                                <input
                                                    class="form-control inputConfig govuk-input"
                                                    id="post_logout_redirect_uris<%= i > 0 ? `-${i}`  : '' %>"
                                                    name="post_logout_redirect_uris"
                                                    value="<%=logout_redirect%>" />
                                            </p>
                                        <% } %>
                                    <% } else { %>
                                        <label for="post_logout_redirect_uris" class="govuk-label govuk-label--s govuk-visually-hidden">
                                            Redirect Url
                                        </label>
                                        <% if (locals.validationMessages.post_logout_redirect_uris !== undefined) { %>
                                        <p id="validation-homeUrl" class="govuk-error-message">
                                            <span class="govuk-visually-hidden">Error:</span>
                                            <%=locals.validationMessages.post_logout_redirect_uris%>
                                        </p>
                                        <% } %>
                                        <p class="govuk-body">
                                            <input
                                                class="form-control inputConfig govuk-input"
                                                id="post_logout_redirect_uris"
                                                name="post_logout_redirect_uris" />
                                        </p>
                                    <% } %>
                                    </fieldset>
                                </div>
                            </dd>
                        </div>
                        <!-- Grant types old section -->
                        <div class="govuk-summary-list__row">
                            <dt class="govuk-summary-list__key">
                                <span class="govuk-label govuk-label--s">Grant types</span>
                            </dt>
                            <dd class="govuk-summary-list__value">
                                <div class="govuk-form-group">
                                    <fieldset class="govuk-fieldset">
                                        <legend class="govuk-fieldset__legend govuk-visually-hidden">Grant types</legend>
                                        <div class="govuk-checkboxes">

                                            <div class="multiple-choice govuk-checkboxes__item">
                                                <input id="authorization_code" class="govuk-checkboxes__input" type="checkbox"
                                                name="grant_types" value="authorization_code" <%=
                                                (locals.service.grantTypes.indexOf('authorization_code') !== -1) ? 'checked' : ''%>>
                                                <label class="govuk-label govuk-checkboxes__label" for="authorization_code">
                                                    authorization_code
                                                </label>
                                            </div>

                                            <div class="multiple-choice govuk-checkboxes__item">
                                                <input id="implicit" class="govuk-checkboxes__input" type="checkbox"
                                                name="grant_types" value="implicit" <%=
                                                (locals.service.grantTypes.indexOf('implicit') !== -1) ? 'checked' : ''%>>
                                                <label class="govuk-label govuk-checkboxes__label" for="implicit">
                                                    implicit
                                                </label>
                                            </div>
                                            <div class="multiple-choice govuk-checkboxes__item">
                                                <input id="client_credentials" class="govuk-checkboxes__input" type="checkbox"
                                                name="grant_types" value="client_credentials" <%=
                                                (locals.service.grantTypes.indexOf('client_credentials') !== -1) ? 'checked' :
                                                ''%>>
                                                <label class="govuk-label govuk-checkboxes__label" for="client_credentials">
                                                    client_credentials
                                                </label>
                                            </div>
                                            <div class="multiple-choice govuk-checkboxes__item">
                                                <input id="refresh_token" class = "govuk-checkboxes__input" type="checkbox"
                                                name="grant_types" value="refresh_token" <%=
                                                (locals.service.grantTypes.indexOf('refresh_token') !== -1) ? 'checked' : ''%>>
                                                <label class="govuk-label govuk-checkboxes__label" for="refresh_token">
                                                    refresh_token
                                                </label>
                                            </div>
                                        </div>
                                    </fieldset>
                                </div>
                            </dd>
                        </div>

                        <div class="govuk-summary-list__row">
                            <dt class="govuk-summary-list__key">
                                <span class="govuk-label govuk-label--s">Response types</span>
                            </dt>
                            <dd class="govuk-summary-list__value">
                                <div class="govuk-form-group">
                                    <fieldset class="govuk-fieldset">
                                        <legend class="govuk-fieldset__legend govuk-visually-hidden">Response types</legend>
                                        <div class="govuk-checkboxes">
                                            <div class="multiple-choice govuk-checkboxes__item">
                                                <input id="code" class ="govuk-checkboxes__input" type="checkbox"
                                                name="response_types" value="code" <%=
                                                (locals.service.responseTypes.indexOf('code') !== -1) ? 'checked' : ''%>>
                                                <label class="govuk-label govuk-checkboxes__label" for="code">code</label>
                                            </div>

                                            <div class="multiple-choice govuk-checkboxes__item">
                                                <input id="id_token" class = "govuk-checkboxes__input" type="checkbox"
                                                name="response_types" value="id_token" <%=
                                                (locals.service.responseTypes.indexOf('id_token') !== -1) ? 'checked' : ''%>>
                                                <label class="govuk-label govuk-checkboxes__label" for="id_token">
                                                    id_token
                                                </label>
                                            </div>
                                            <div class="multiple-choice govuk-checkboxes__item">
                                                <input id="token" class = "govuk-checkboxes__input" type="checkbox"
                                                name="response_types" value="token" <%=
                                                (locals.service.responseTypes.indexOf('token') !== -1) ? 'checked' : ''%>>
                                                <label class="govuk-label govuk-checkboxes__label" for="token">token</label>
                                            </div>
                                        </div>
                                    </fieldset>
                                </div>
                            </dd>
                        </div>

                        <div class="govuk-summary-list__row">
                            <dt class="govuk-summary-list__key">
                                <label class="govuk-label govuk-label--s" for="tokenEndpointAuthMethod">
                                    Token endpoint authentication method
                                </label>
                            </dt>
                            <dd class="govuk-summary-list__value">
                                <div class="govuk-form-group">
                                    <select
                                        class="govuk-select"
                                        id="tokenEndpointAuthMethod"
                                        name="tokenEndpointAuthMethod">
                                        <option disabled value>Select token endpoint authentication method</option>
                                        <option <%=((locals.service.tokenEndpointAuthMethod && locals.service.tokenEndpointAuthMethod) === 'client_secret_post') ? 'selected="selected"' : ''%> value="client_secret_post">client_secret_post</option>
                                        <option <%=!locals.service.tokenEndpointAuthMethod ? 'selected="selected"' : ''%>value="">none</option>
                                    </select>
                                </div>
                            </dd>
                        </div>
                    </dl>
                </fieldset>

                <fieldset  class="govuk-fieldset govuk-!-margin-top-3">
                    <legend class="govuk-fieldset__legend govuk-fieldset__legend--m">
                        API
                    </legend>
                    <dl class="govuk-summary-list">
                        <div class="govuk-summary-list__row">
                            <dt class="govuk-summary-list__key">
                                <label class="govuk-label govuk-label--s" for="apiSecret">
                                    Secret
                                </label>
                            </dt>
                            <dd class="govuk-summary-list__value">
                                <div
                                    class="govuk-form-group <%= (locals.validationMessages.apiSecret !== undefined) ? 'govuk-form-group--error' : '' %>">
                                    <a href="" class="pull-right" id="generate-api-secret">Regenerate</a>
                                    <% if (locals.validationMessages.apiSecret !== undefined) { %>
                                    <p class="error-message" id="validation-homeUrl">
                                        <%=locals.validationMessages.apiSecret %>
                                    </p>
                                    <% } %>
                                    <div class="show-password" id="secret-input">
                                        <input
                                            class="form-control read-only-input govuk-input password-input"
                                            id="apiSecret"
                                            name="apiSecret"
                                            type="password"
                                            value="<%=locals.service.apiSecret%>"
                                            readonly="readonly" />
                                    </div>
                                </div>
                            </dd>
                        </div>
                    </dl>
                </fieldset> 

                <div class="govuk-button-group auto-scroll-dest">
                    <button type="submit" class="govuk-button" data-module="govuk-button">Save</button>
                    <a href="<%= locals.backLink %>" class="govuk-button govuk-button--secondary">Cancel</a>
                </div>
            </form>
        </div>
    </div>
</div>
